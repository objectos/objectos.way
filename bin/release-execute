#!/bin/bash

set -e -u -o pipefail

props="release.props"

if [ ! -f "$props" ]; then
	echo
	echo "Cannot proceed"
	echo "${props} was not found."
	echo
	
	exit 1
fi

while IFS='=' read -r key value; do
	eval ${key}=\${value}
done < "$props"

echo
echo "----------------------"
echo "Hello! The release script will run with the following options:"
echo 
echo "      release=${release}"
echo "     www slug=${slug}"
echo "      javadoc=${javadoc}"
echo
echo "----------------------"
echo

# https://stackoverflow.com/a/1885534
read -p "Enter y/Y to proceed. Any other key to cancel." -n 1 -r
echo

if [[ ! $REPLY =~ ^[yY]$ ]]; then
	[[ "$0" = "$BASH_SOURCE" ]] && exit 1 || return 1
fi

echo
echo "Running mvn javadoc:aggregate"
echo 

mvn --quiet -PskipTests -DdestDir="api" -DreportOutputDirectory="${javadoc}/${slug}" javadoc:aggregate

rm -r ${javadoc}/latest/api
rsync -a ${javadoc}/${slug}/api ${javadoc}/latest

echo
echo "Running mvn deploy"
echo 

MAVEN_OPTS=""
MAVEN_OPTS="$MAVEN_OPTS --add-opens java.base/java.util=ALL-UNNAMED"
MAVEN_OPTS="$MAVEN_OPTS --add-opens java.base/java.lang.reflect=ALL-UNNAMED"
MAVEN_OPTS="$MAVEN_OPTS --add-opens java.base/java.text=ALL-UNNAMED"
MAVEN_OPTS="$MAVEN_OPTS --add-opens java.desktop/java.awt.font=ALL-UNNAMED"

export MAVEN_OPTS

mvn --quiet -Prelease,skipTests deploy

echo
echo "Tagging ${release}"
echo 

git tag -a "objectos-${release}" -m "Objectos ${release}"
git push origin master
git push origin --tags
git push github master
git push github --tags